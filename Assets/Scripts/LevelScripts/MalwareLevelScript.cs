using System;
using UnityEngine.SceneManagement;

class MalwareLevelScript : LevelScript
{
    string levelName = "Malware";
    string task1description = "Download and play the game";
    string task2description = "Run the antivirus";
    string optionalTaskDescription = "Optionally: Delete found malware";
    Boolean task1completed = false;
    Boolean task2completed = false;
    Boolean optionalTaskCompleted = false;

    GameEngine game;

    public MalwareLevelScript(GameEngine gameEngine)
    {
        this.game = gameEngine;
    }

    public void Init()
    {
        game.SetTasks(task1description, task2description, optionalTaskDescription);

        // Display some information about thread in a window
        // todo

        Phase1();
    }

    public void Phase1()
    {
        LoggingService.Log(LoggingService.LogCategory.Level, levelName + ": Phase 1");

        // Player open browser
        game.internetButton.gameObject.SetActive(true);
        game.internetButton.onClick.AddListener(() => { game.browserWindow.SetActive(true); });

        // Player download game
        game.downloadGame1Button.onClick.AddListener(() => { game.gameButton1.gameObject.SetActive(true); });
        game.downloadGame2Button.onClick.AddListener(() => { game.gameButton2.gameObject.SetActive(true); });
        game.downloadGame3Button.onClick.AddListener(() => { game.gameButton3.gameObject.SetActive(true); });

        // Player try to run game
        game.gameButton1.onClick.AddListener(() => { game.gotHackedWindow.SetActive(true); });
        game.gameButton2.onClick.AddListener(() => { game.gotHackedWindow.SetActive(true); });
        game.gameButton3.onClick.AddListener(() => { game.gotHackedWindow.SetActive(true); });

        // Player revert back
        game.tryAgainButton.onClick.AddListener(() =>
        {
            // Got hacked window will disappear
            game.gotHackedWindow.SetActive(false);

            if (game.gameButton1.gameObject.activeSelf && game.gameButton2.gameObject.activeSelf && game.gameButton3.gameObject.activeSelf)
            {
                Phase2();
            }
        });
    }

    public void Phase2()
    {
        LoggingService.Log(LoggingService.LogCategory.Level, levelName + ": Phase 2");

        // Antivirus icon will appear
        game.antivirusButton.gameObject.SetActive(true);

        // Player runs antivirus (the minigame)
        game.antivirusButton.onClick.AddListener(() =>
        {
            // todo implement the minigame
            SceneManager.LoadScene("Antivirus", LoadSceneMode.Additive);
            Phase3();
        });
    }

    public void Phase3()
    {
        LoggingService.Log(LoggingService.LogCategory.Level, levelName + ": Phase 3");

        task2completed = true;

        // Antivirus detects which file is malware
        game.gameButton1Cross.SetActive(true);
        game.gameButton2Check.SetActive(true);
        game.gameButton2.onClick.RemoveAllListeners();
        game.gameButton2.onClick.AddListener(() => Phase4());
        game.gameButton3Cross.SetActive(true);

        // Reveal recycle bin
        game.trashDropZone.SetActive(true);
    }
    public void Phase4()
    {
        LoggingService.Log(LoggingService.LogCategory.Level, levelName + ": Phase 4");

        task1completed = true;
        FinishLevel();
    }
    public void FinishLevel()
    {
        float gameIconsLeft = 0;
        if (game.gameButton1.IsActive()) { gameIconsLeft++; }
        if (game.gameButton2.IsActive()) { gameIconsLeft++; }
        if (game.gameButton3.IsActive()) { gameIconsLeft++; }
        if (gameIconsLeft == 1) { optionalTaskCompleted = true; }

        LoggingService.Log(LoggingService.LogCategory.Level, levelName + ": Finished with: " + ((task1completed ? 1 : 0) + (task2completed ? 1 : 0) + (optionalTaskCompleted ? 1 : 0)) + " stars");

        // Display box with tasks completed
        game.levelCompletedPopUp.SetActive(true);
        game.levelCompletedSetStars(task1completed, task2completed, optionalTaskCompleted);
    }
}
